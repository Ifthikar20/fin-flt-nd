import 'dart:typed_data';
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';
import '../screens/splash_screen.dart';
import '../screens/onboarding_screen.dart';
import '../screens/login_screen.dart';
import '../screens/register_screen.dart';
import '../screens/home_screen.dart';
import '../screens/search_results_screen.dart';
import '../screens/camera_screen.dart';
import '../screens/image_results_screen.dart';
import '../screens/favorites_screen.dart';
import '../screens/fashion_board_screen.dart';
import '../screens/fashion_board_editor.dart';
import '../screens/fashion_board_share_screen.dart';
import '../screens/profile_screen.dart';
import '../screens/brand_screen.dart';
import '../screens/product_detail_screen.dart';
import '../screens/app_shell.dart';
import '../models/deal.dart';
import '../models/storyboard.dart';

final GoRouter appRouter = GoRouter(
  initialLocation: '/splash',
  routes: [
    GoRoute(
      path: '/splash',
      builder: (context, state) => const SplashScreen(),
    ),
    GoRoute(
      path: '/onboarding',
      builder: (context, state) => const OnboardingScreen(),
    ),
    GoRoute(
      path: '/login',
      builder: (context, state) => const LoginScreen(),
    ),
    GoRoute(
      path: '/register',
      builder: (context, state) => const RegisterScreen(),
    ),

    // ─── Main App Shell (with bottom nav) ──────
    ShellRoute(
      builder: (context, state, child) => AppShell(child: child),
      routes: [
        GoRoute(
          path: '/',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: HomeScreen(),
          ),
        ),
        GoRoute(
          path: '/favorites',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: FavoritesScreen(),
          ),
        ),
        GoRoute(
          path: '/boards',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: FashionBoardScreen(),
          ),
        ),
        GoRoute(
          path: '/profile',
          pageBuilder: (context, state) => const NoTransitionPage(
            child: ProfileScreen(),
          ),
        ),
      ],
    ),

    // ─── Full-screen Pages ─────────────────────
    GoRoute(
      path: '/search',
      builder: (context, state) {
        final query = state.uri.queryParameters['q'] ?? '';
        return SearchResultsScreen(query: query);
      },
    ),
    GoRoute(
      path: '/camera',
      pageBuilder: (context, state) => CustomTransitionPage(
        key: state.pageKey,
        child: const CameraScreen(),
        transitionDuration: const Duration(milliseconds: 200),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(opacity: animation, child: child);
        },
      ),
    ),
    GoRoute(
      path: '/image-results',
      builder: (context, state) {
        final extra = state.extra as Map<String, dynamic>?;
        return ImageResultsScreen(
          imagePath: extra?['imagePath'] ?? '',
        );
      },
    ),
    GoRoute(
      path: '/boards/editor',
      builder: (context, state) {
        final extra = state.extra as Map<String, dynamic>?;
        return FashionBoardEditor(
          existingBoard: extra?['storyboard'] as Storyboard?,
        );
      },
    ),
    GoRoute(
      path: '/boards/share',
      builder: (context, state) {
        final extra = state.extra as Map<String, dynamic>? ?? {};
        return FashionBoardShareScreen(
          boardData: extra['boardData'] as Map<String, dynamic>? ?? {},
          title: extra['title'] as String? ?? 'My Board',
          imageBytes: extra['imageBytes'] as Uint8List?,
          existingBoard: extra['existingBoard'] as Storyboard?,
        );
      },
    ),

    GoRoute(
      path: '/brand/:name',
      builder: (context, state) {
        final name = Uri.decodeComponent(state.pathParameters['name'] ?? '');
        return BrandScreen(brandName: name);
      },
    ),
    GoRoute(
      path: '/deal',
      builder: (context, state) {
        final deal = state.extra as Deal;
        return ProductDetailScreen(deal: deal);
      },
    ),
  ],
);
